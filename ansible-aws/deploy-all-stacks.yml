---
# Master Orchestrator: Deploy All Stacks
# Chapter 5: Micro Stack Pattern - Page 62
#
# This playbook orchestrates the deployment of all infrastructure stacks
# in the correct dependency order, reducing blast radius of changes.
#
# Usage:
#   ansible-playbook deploy-all-stacks.yml                    # Deploy all
#   ansible-playbook deploy-all-stacks.yml --tags monitoring  # Only monitoring
#   ansible-playbook deploy-all-stacks.yml --skip-tags network  # Skip network

- name: Master Orchestrator - Deploy All Infrastructure Stacks
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars_files:
    - shared-vars.yml
  
  tasks:
    # ========================================================================
    # Deployment Banner
    # ========================================================================
    
    - name: "[Orchestrator] Display deployment information"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘        MICRO STACK DEPLOYMENT ORCHESTRATOR                    â•‘"
          - "â•‘     Chapter 5: Building Infrastructure Stacks as Code         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“š Book Reference: Infrastructure as Code by Kief Morris"
          - "   Chapter 5, Pattern: Micro Stack (Page 62)"
          - ""
          - "ğŸ¯ Deployment Strategy:"
          - "   â€¢ Break infrastructure into small, independent stacks"
          - "   â€¢ Reduce blast radius from 100% â†’ ~20% per change"
          - "   â€¢ Enable independent testing and rollback"
          - ""
          - "ğŸ“Š Stack Order (by dependency):"
          - "   1. Network Stack    (~15% blast radius)"
          - "   2. Compute Stack    (~30% blast radius)"
          - "   3. Database Stack   (~20% blast radius)"
          - "   4. Monitoring Stack (~10% blast radius)"
          - "   5. Application Stack (~15% blast radius)"
          - ""
          - "â±ï¸  Estimated Total Time: 20-30 minutes (first deployment)"
          - "â±ï¸  Individual Stack: 3-12 minutes each"
          - ""
          - "ğŸ”§ Cluster Configuration:"
          - "   â€¢ Cluster: {{ cluster_name }}"
          - "   â€¢ Region: {{ aws_region }}"
          - "   â€¢ Nodes: {{ node_min_size }}-{{ node_max_size }} ({{ node_instance_type }})"
          - "   â€¢ Version: {{ cluster_version }}"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "   Starting deployment at {{ ansible_date_time.iso8601 }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
    
    # ========================================================================
    # Stack 1: Network Stack (Foundation)
    # ========================================================================
    
    - name: "[Stack 1/5] Network Stack - VPC and Networking"
      block:
        - name: Display stack start
          debug:
            msg:
              - ""
              - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              - "â•‘  STACK 1/5: NETWORK STACK                                     â•‘"
              - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              - "  Purpose: Base networking infrastructure"
              - "  Dependencies: None (foundation)"
              - "  Blast Radius: ~15%"
              - ""
        
        - name: Execute Network Stack
          include_tasks: stacks/01-network-stack.yml
          
        - name: Stack completion
          debug:
            msg: "âœ… Network Stack deployment complete"
      tags: [network, foundation]
    
    # ========================================================================
    # Stack 2: Compute Stack (Cluster Infrastructure)
    # ========================================================================
    
    - name: "[Stack 2/5] Compute Stack - EKS and Node Groups"
      block:
        - name: Display stack start
          debug:
            msg:
              - ""
              - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              - "â•‘  STACK 2/5: COMPUTE STACK                                     â•‘"
              - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              - "  Purpose: Kubernetes cluster and node groups"
              - "  Dependencies: Network Stack"
              - "  Blast Radius: ~30%"
              - ""
        
        - name: Execute Compute Stack
          include_tasks: stacks/03-compute-stack.yml
          
        - name: Stack completion
          debug:
            msg: "âœ… Compute Stack deployment complete"
      tags: [compute, cluster]
    
    # ========================================================================
    # Stack 3: Database Stack (Persistent Storage)
    # ========================================================================
    
    - name: "[Stack 3/5] Database Stack - PostgreSQL and Storage"
      block:
        - name: Display stack start
          debug:
            msg:
              - ""
              - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              - "â•‘  STACK 3/5: DATABASE STACK                                    â•‘"
              - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              - "  Purpose: Persistent data storage"
              - "  Dependencies: Network Stack"
              - "  Blast Radius: ~20%"
              - ""
        
        - name: Execute Database Stack
          include_tasks: stacks/02-database-stack.yml
          
        - name: Stack completion
          debug:
            msg: "âœ… Database Stack deployment complete"
      tags: [database, storage]
    
    # ========================================================================
    # Stack 4: Monitoring Stack (Observability)
    # ========================================================================
    
    - name: "[Stack 4/5] Monitoring Stack - Prometheus and Grafana"
      block:
        - name: Display stack start
          debug:
            msg:
              - ""
              - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              - "â•‘  STACK 4/5: MONITORING STACK                                  â•‘"
              - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              - "  Purpose: Observability and metrics"
              - "  Dependencies: Compute Stack"
              - "  Blast Radius: ~10%"
              - ""
        
        - name: Execute Monitoring Stack
          include_tasks: stacks/04-monitoring-stack.yml
          
        - name: Stack completion
          debug:
            msg: "âœ… Monitoring Stack deployment complete"
      tags: [monitoring, observability]
    
    # ========================================================================
    # Stack 5: Application Stack (User-Facing Services)
    # ========================================================================
    
    - name: "[Stack 5/5] Application Stack - do-sample-app and Services"
      block:
        - name: Display stack start
          debug:
            msg:
              - ""
              - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              - "â•‘  STACK 5/5: APPLICATION STACK                                 â•‘"
              - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              - "  Purpose: User-facing application"
              - "  Dependencies: Compute Stack, Database Stack"
              - "  Blast Radius: ~15%"
              - ""
        
        - name: Execute Application Stack
          include_tasks: stacks/05-application-stack.yml
          
        - name: Stack completion
          debug:
            msg: "âœ… Application Stack deployment complete"
      tags: [application, app]
    
    # ========================================================================
    # Final Summary
    # ========================================================================
    
    - name: "[Orchestrator] Display final deployment summary"
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘          ALL STACKS DEPLOYED SUCCESSFULLY                     â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ… Deployment Complete:"
          - "   â€¢ Network Stack: Validated"
          - "   â€¢ Compute Stack: EKS cluster running"
          - "   â€¢ Database Stack: PostgreSQL ready"
          - "   â€¢ Monitoring Stack: Prometheus + Grafana"
          - "   â€¢ Application Stack: do-sample-app deployed"
          - ""
          - "ğŸ¯ Benefits of Micro Stack Pattern:"
          - "   â€¢ Reduced blast radius: 10-30% per stack vs 100% monolithic"
          - "   â€¢ Faster deployments: 3-12 min per stack vs 15+ min all"
          - "   â€¢ Independent testing: Each stack validates separately"
          - "   â€¢ Easier rollback: Revert individual stacks, not all"
          - "   â€¢ Team ownership: Different teams can own different stacks"
          - ""
          - "ğŸ“Š Stack Statistics:"
          - "   â€¢ Total Stacks: 5"
          - "   â€¢ Average Blast Radius: 18%"
          - "   â€¢ Deployment Time: {{ ansible_date_time.iso8601 }}"
          - "   â€¢ Infrastructure Version: {{ stack_version }}"
          - ""
          - "ğŸ”§ Next Steps:"
          - "   1. Verify all services: kubectl get pods --all-namespaces"
          - "   2. Check application: curl http://APP_URL"
          - "   3. View metrics: Open Grafana dashboard"
          - "   4. Run load test: Open Locust UI"
          - ""
          - "ğŸ“ To update individual stacks:"
          - "   ansible-playbook deploy-all-stacks.yml --tags monitoring"
          - "   ansible-playbook deploy-all-stacks.yml --tags application"
          - "   ansible-playbook deploy-all-stacks.yml --tags database"
          - ""
          - "ğŸ“š Book Reference:"
          - "   Infrastructure as Code by Kief Morris"
          - "   Chapter 5: Pattern: Micro Stack (Page 62)"
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘   Chapter 5 Implementation: PRODUCTION READY                  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
